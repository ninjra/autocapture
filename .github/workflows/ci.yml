name: CI

on:
  push:
  pull_request:

jobs:
  cpu-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: poetry.lock
      - name: Install Poetry
        run: pip install poetry==1.8.3
      - name: Install dependencies
        timeout-minutes: 15
        run: poetry install --with dev --extras "sqlcipher" --no-interaction --no-ansi --sync -vvv
      - name: Run CPU check
        run: make check
      - name: Verify checksums
        run: poetry run python tools/verify_checksums.py
      - name: License guardrails
        run: poetry run python tools/license_guardrails.py
      - name: Prompt template security gate
        run: poetry run python -m autocapture.promptops.validate

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: poetry.lock
      - name: Install Poetry
        run: pip install poetry==1.8.3
      - name: Show versions
        run: |
          python --version
          pip --version
          poetry --version
      - name: Install dependencies
        timeout-minutes: 15
        run: poetry install --with dev --extras "sqlcipher" --no-interaction --no-ansi --sync -vvv
      - name: Memory guard
        run: python .tools/memory_guard.py --check
      - name: Verify checksums
        run: poetry run python tools/verify_checksums.py
      - name: License guardrails
        run: poetry run python tools/license_guardrails.py

      - name: Release gate
        env:
          STRICT_FROZEN_SURFACES: "1"
        run: poetry run python tools/release_gate.py

  spec1-bench:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: poetry.lock
      - name: Install Poetry
        run: pip install poetry==1.8.3
      - name: Install dependencies
        timeout-minutes: 15
        run: poetry install --with dev --no-interaction --no-ansi --sync -vvv
      - name: Run offline bench
        env:
          BENCH_ITERATIONS: "10"
          BENCH_WARMUP: "2"
        run: |
          chmod +x bench/run.sh
          bench/run.sh
      - name: Bench regression gate
        run: poetry run python bench/ci_gate.py --baseline bench/baseline.json --current bench/results/summary.json --case-id case1 --mode offline
      - name: Upload bench artifacts
        uses: actions/upload-artifact@v4
        with:
          name: spec1-bench-results
          path: bench/results/**

  windows-build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: poetry.lock
      - name: Install Poetry
        run: pip install poetry==1.8.3
      - name: Show versions
        run: |
          python --version
          pip --version
          poetry --version
      - name: Install dependencies
        timeout-minutes: 20
        run: poetry install --with dev --extras "ui windows ocr ocr-gpu embed-fast sqlcipher" --no-interaction --no-ansi --sync -vvv
      - name: Memory guard
        run: python .tools/memory_guard.py --check
      - name: Install Inno Setup
        run: choco install innosetup -y
      - name: Release gate
        run: poetry run python tools/release_gate.py
      - name: Verify checksums
        run: poetry run python tools/verify_checksums.py
      - name: License guardrails
        run: poetry run python tools/license_guardrails.py
      - name: Overlay tracker Windows tests
        run: poetry run pytest -q tests/test_overlay_tracker_windows.py
      - name: Upload PyInstaller bundle
        uses: actions/upload-artifact@v4
        with:
          name: autocapture-windows-bundle
          path: dist/autocapture
      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: autocapture-windows-installer
          path: dist-installer/*.exe

  next10-gates:
    runs-on: windows-latest
    env:
      AUTOCAPTURE_TEST_MODE: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: poetry.lock
      - name: Install Poetry
        run: pip install poetry==1.8.3
      - name: Install dependencies
        timeout-minutes: 20
        run: poetry install --with dev --extras "sqlcipher" --no-interaction --no-ansi --sync -vvv
      - name: Pillar gate
        run: poetry run python tools/pillar_gate.py
      - name: Verify checksums
        run: poetry run python tools/verify_checksums.py
      - name: License guardrails
        run: poetry run python tools/license_guardrails.py
      - name: Privacy scanner
        run: poetry run python tools/privacy_scanner.py
      - name: Provenance gate
        run: poetry run python tools/provenance_gate.py
      - name: Coverage gate
        run: poetry run python tools/coverage_gate.py
      - name: Latency gate
        run: poetry run python tools/latency_gate.py
      - name: Retrieval sensitivity gate
        run: poetry run python tools/retrieval_sensitivity.py
      - name: No-evidence gate
        run: poetry run python tools/no_evidence_gate.py
      - name: Conflict gate
        run: poetry run python tools/conflict_gate.py
      - name: Integrity gate
        run: poetry run python tools/integrity_gate.py
